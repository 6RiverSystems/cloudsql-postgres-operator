apiVersion: v1
kind: Secret
metadata:
  labels:
    app: cloudsql-postgres-operator
  name: cloudsql-postgres-operator
  namespace: cloudsql-postgres-operator
stringData:
  admin-key.json: |
    <iam-service-account-credentials-file>
---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app: cloudsql-postgres-operator
  name: cloudsql-postgres-operator
  namespace: cloudsql-postgres-operator
data:
  config.toml: |
    [gcp]
    admin_service_account_key_path = "/secret/admin-key.json"
    project_id = "<project-id>"
    [logging]
    level = "trace"
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: cloudsql-postgres-operator
  name: cloudsql-postgres-operator
  namespace: cloudsql-postgres-operator
spec:
  selector:
    app: cloudsql-postgres-operator
  ports:
  - name: admission
    port: 443
    targetPort: 443
  type: ClusterIP
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: cloudsql-postgres-operator
  name: cloudsql-postgres-operator
  namespace: cloudsql-postgres-operator
spec:
  containers:
  - name: cloudsql-postgres-operator
    image: "gcr.io/<project-id>/cloudsql-postgres-operator"
    imagePullPolicy: IfNotPresent
    args:
    - /cloudsql-postgres-operator
    - --config-file
    - /config/config.toml
    ports:
    - name: admission
      containerPort: 443
    readinessProbe:
      httpGet:
        path: /healthz
        port: admission
        scheme: HTTPS
    volumeMounts:
    - mountPath: /config
      name: config
      readOnly: true
    - mountPath: /secret
      name: secret
      readOnly: true
  volumes:
  - name: config
    configMap:
      name: cloudsql-postgres-operator
  - name: secret
    secret:
      secretName: cloudsql-postgres-operator
  serviceAccountName: cloudsql-postgres-operator
